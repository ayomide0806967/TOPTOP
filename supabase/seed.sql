-- Seed baseline data for CBT Fast environment
-- Includes admin profile, catalog scaffolding, study cycles, questions, and subscription offerings

-- Ensure the requested admin profile exists with elevated permissions
insert into public.profiles (id, full_name, role, last_seen_at)
values
  ('230348b8-0bf5-44a9-861e-4373289efdfc', 'CBT Operations Admin', 'admin', timezone('utc', now()))
on conflict (id) do update set
  full_name = excluded.full_name,
  role = excluded.role,
  last_seen_at = excluded.last_seen_at,
  updated_at = timezone('utc', now());

-- Departments ----------------------------------------------------------------
insert into public.departments (id, name, slug, color_theme)
values
  ('1dd7c0aa-6fa2-4268-8b3c-4d634eec1a73', 'School of Nursing', 'nursing', 'nursing'),
  ('e76fd3f8-36cc-4bdb-9d6e-2bd9badf9a33', 'School of Midwifery', 'midwifery', 'midwifery'),
  ('4f31dadf-faa9-4104-a7d0-9280b3fee4dc', 'School of Public Health', 'public-health', 'public-health')
on conflict (slug) do update set
  name = excluded.name,
  color_theme = excluded.color_theme,
  updated_at = timezone('utc', now());

-- Courses --------------------------------------------------------------------
insert into public.courses (id, department_id, name, slug, description)
values
  ('68afcf6f-99a5-4c89-9b22-1cb3aba3895c',
    (select id from public.departments where slug = 'nursing'),
    'Foundations of Nursing Practice',
    'foundations-of-nursing-practice',
    'Core clinical competencies, professional standards, and patient communication skills.'),
  ('f5809805-1fc7-48b7-9e63-3b103bb8f89d',
    (select id from public.departments where slug = 'nursing'),
    'Medical-Surgical Nursing',
    'medical-surgical-nursing',
    'Advanced nursing care for patients with complex medical and surgical conditions.'),
  ('33edbf96-1ddb-4f09-9f6d-8e436b67cb8e',
    (select id from public.departments where slug = 'midwifery'),
    'Antenatal Care Essentials',
    'antenatal-care-essentials',
    'Evidence-based screening, assessment, and client education during pregnancy.'),
  ('7f5f9bdc-a213-4e7f-a6b1-913b0f7ad824',
    (select id from public.departments where slug = 'midwifery'),
    'Labour and Delivery Management',
    'labour-and-delivery-management',
    'Intrapartum care, emergency response, and safe delivery practices.'),
  ('4a4f4027-7c78-4c5f-810d-7feaf0011cbd',
    (select id from public.departments where slug = 'public-health'),
    'Epidemiology Basics',
    'epidemiology-basics',
    'Quantifying disease, interpreting surveillance data, and outbreak response.'),
  ('5bd0eb75-83bf-4db9-af7f-96a3d186d21c',
    (select id from public.departments where slug = 'public-health'),
    'Community Health Strategies',
    'community-health-strategies',
    'Programme planning and evaluation for community-focused health initiatives.' )
on conflict (department_id, slug) do update set
  name = excluded.name,
  description = excluded.description,
  updated_at = timezone('utc', now());

-- Topics ---------------------------------------------------------------------
insert into public.topics (id, course_id, name, slug, question_count)
values
  ('4a4d5b76-4017-4a94-a2d6-b1dab5d5caf6',
    (select id from public.courses where slug = 'foundations-of-nursing-practice'),
    'Infection Control Fundamentals',
    'infection-control',
    0),
  ('cb481d94-1d4f-40e2-9801-0e49e43d1bfb',
    (select id from public.courses where slug = 'foundations-of-nursing-practice'),
    'Vital Signs Assessment',
    'vital-signs-assessment',
    0),
  ('6857d0dd-d099-4b0d-9fec-8837c3fb2ba4',
    (select id from public.courses where slug = 'medical-surgical-nursing'),
    'Post-Operative Care Priorities',
    'post-operative-care',
    0),
  ('8cbc2e69-43a5-404b-86a0-e7156f1e3c28',
    (select id from public.courses where slug = 'antenatal-care-essentials'),
    'Prenatal Screening Guidelines',
    'prenatal-screenings',
    0),
  ('b1abead2-36b0-4e06-a5b0-5b6dfef32c76',
    (select id from public.courses where slug = 'labour-and-delivery-management'),
    'Labour Progression Stages',
    'labour-stages',
    0),
  ('ac0b868a-fd1c-49d3-bd28-9f7f1422cf5d',
    (select id from public.courses where slug = 'epidemiology-basics'),
    'Outbreak Investigation Steps',
    'outbreak-investigation',
    0),
  ('1cd8b8ac-fae2-4f10-a8b1-96bff635f513',
    (select id from public.courses where slug = 'community-health-strategies'),
    'Health Education Methods',
    'health-education-methods',
    0)
on conflict (course_id, slug) do update set
  name = excluded.name,
  updated_at = timezone('utc', now());

-- Study cycles ---------------------------------------------------------------
insert into public.study_cycles (id, department_id, title, code, start_date, status, duration_days, questions_per_day, question_cap)
values
  ('d9cbad1f-3c69-4f38-87d5-b3cce966f7b1',
    (select id from public.departments where slug = 'nursing'),
    'November NCLEX Sprint',
    'nursing-november-slot',
    '2024-11-04',
    'scheduled',
    30,
    250,
    7000),
  ('1ce87c93-e792-47f5-8a7b-944261f264ad',
    (select id from public.departments where slug = 'midwifery'),
    'Maternal Care Bootcamp',
    'midwifery-october-slot',
    '2024-10-14',
    'scheduled',
    30,
    250,
    7000)
on conflict (id) do update set
  title = excluded.title,
  code = excluded.code,
  start_date = excluded.start_date,
  status = excluded.status,
  duration_days = excluded.duration_days,
  questions_per_day = excluded.questions_per_day,
  question_cap = excluded.question_cap,
  updated_at = timezone('utc', now());

insert into public.study_cycle_weeks (id, study_cycle_id, week_index, day_span, start_date, end_date, question_target, question_count, status)
values
  ('1a5bf0a0-8f3d-4d43-893b-697951af29ef',
    (select id from public.study_cycles where id = 'd9cbad1f-3c69-4f38-87d5-b3cce966f7b1'),
    1,
    8,
    '2024-11-04',
    '2024-11-11',
    2000,
    0,
    'active'),
  ('13b8df9a-2af7-4f59-9934-0c815530fef0',
    (select id from public.study_cycles where id = 'd9cbad1f-3c69-4f38-87d5-b3cce966f7b1'),
    2,
    7,
    '2024-11-12',
    '2024-11-18',
    1750,
    0,
    'pending'),
  ('f1f90a31-ebb0-41d8-996f-41d0d1c27301',
    (select id from public.study_cycles where id = 'd9cbad1f-3c69-4f38-87d5-b3cce966f7b1'),
    3,
    8,
    '2024-11-19',
    '2024-11-26',
    2000,
    0,
    'pending'),
  ('eb17831d-8a3c-401a-b3e7-1d0ff20d4115',
    (select id from public.study_cycles where id = 'd9cbad1f-3c69-4f38-87d5-b3cce966f7b1'),
    4,
    7,
    '2024-11-27',
    '2024-12-03',
    1750,
    0,
    'draft'),
  ('2fb271c4-a9f6-4f70-85da-178f44bcbf86',
    (select id from public.study_cycles where id = '1ce87c93-e792-47f5-8a7b-944261f264ad'),
    1,
    8,
    '2024-10-14',
    '2024-10-21',
    2000,
    0,
    'active'),
  ('64132e63-b16d-4271-954a-70c640cd97d6',
    (select id from public.study_cycles where id = '1ce87c93-e792-47f5-8a7b-944261f264ad'),
    2,
    7,
    '2024-10-22',
    '2024-10-28',
    1750,
    0,
    'pending')
on conflict (study_cycle_id, week_index) do update set
  day_span = excluded.day_span,
  start_date = excluded.start_date,
  end_date = excluded.end_date,
  question_target = excluded.question_target,
  question_count = excluded.question_count,
  status = excluded.status,
  updated_at = timezone('utc', now());

-- Subscription catalogue ----------------------------------------------------
insert into public.subscription_products (id, code, name, product_type, description, metadata, department_id, is_active)
values
  ('7a3f4e49-6ae6-4dbe-9bb1-8c9980d6d5c6',
    'nursing-cbt',
    'Nursing Practice Prep',
    'cbt',
    'Department-specific daily drills for School of Nursing learners.',
    jsonb_build_object('catalogOrder', 1),
    (select id from public.departments where slug = 'nursing'),
    true),
  ('c833d41e-2dc6-4ef0-a1cb-00a2a64665c8',
    'midwifery-cbt',
    'Midwifery Mastery Plan',
    'cbt',
    'Daily question routines tailored for School of Midwifery candidates.',
    jsonb_build_object('catalogOrder', 2),
    (select id from public.departments where slug = 'midwifery'),
    true),
  ('5db8b46e-49a0-49cc-b65e-2b9bfb4fd21c',
    'community-health-cbt',
    'Community Health Accelerator',
    'cbt',
    'Community and public health learners receive curated daily practise sessions.',
    jsonb_build_object('catalogOrder', 3),
    (select id from public.departments where slug = 'public-health'),
    true),
  ('b1b214b4-a29c-4238-9401-8d707e6dc52f',
    'quiz-builder',
    'Team Quiz Builder',
    'quiz-builder',
    'Collaborative question authoring workspace with review workflows.',
    jsonb_build_object('catalogOrder', 4),
    null,
    true)
on conflict (code) do update set
  name = excluded.name,
  product_type = excluded.product_type,
  description = excluded.description,
  metadata = excluded.metadata,
  department_id = excluded.department_id,
  is_active = excluded.is_active,
  updated_at = timezone('utc', now());

insert into public.subscription_plans (id, product_id, code, name, price, currency, questions, quizzes, participants, metadata, is_active, daily_question_limit, duration_days, plan_tier, quiz_duration_minutes)
values
  ('d3f2d0a6-8d23-4c16-9c2c-2f4ab65c7ed4',
    (select id from public.subscription_products where code = 'nursing-cbt'),
    'nursing-100-daily',
    'Nursing · 100 Daily',
    2900,
    'NGN',
    3000,
    null,
    1,
    jsonb_build_object('dailyLimit', 100, 'tagline', 'Consistent progress for self-paced learners'),
    true,
    100,
    30,
    'daily-100',
    45),
  ('e5c9a2bc-6ab8-402e-8c18-a52f5d96a323',
    (select id from public.subscription_products where code = 'nursing-cbt'),
    'nursing-200-daily',
    'Nursing · 200 Daily',
    3900,
    'NGN',
    6000,
    null,
    1,
    jsonb_build_object('dailyLimit', 200, 'tagline', 'Accelerated prep with double coverage'),
    true,
    200,
    30,
    'daily-200',
    60),
  ('5f7d8c44-84eb-4da9-b5c3-1d7c3efbda76',
    (select id from public.subscription_products where code = 'nursing-cbt'),
    'nursing-250-daily',
    'Nursing · 250 Daily',
    4990,
    'NGN',
    7500,
    null,
    1,
    jsonb_build_object('dailyLimit', 250, 'tagline', 'Full throttle question mastery'),
    true,
    250,
    30,
    'daily-250',
    75),
  ('f660bb3f-20d9-4bcc-b434-3f9b4f8f1639',
    (select id from public.subscription_products where code = 'midwifery-cbt'),
    'midwifery-100-daily',
    'Midwifery · 100 Daily',
    2900,
    'NGN',
    3000,
    null,
    1,
    jsonb_build_object('dailyLimit', 100),
    true,
    100,
    30,
    'daily-100',
    45),
  ('3b7a66ae-d3f9-4a7d-86a7-3e18c2d55943',
    (select id from public.subscription_products where code = 'midwifery-cbt'),
    'midwifery-200-daily',
    'Midwifery · 200 Daily',
    3900,
    'NGN',
    6000,
    null,
    1,
    jsonb_build_object('dailyLimit', 200),
    true,
    200,
    30,
    'daily-200',
    60),
  ('a8b2d4f1-14f9-4c22-a352-f95bc24dcaad',
    (select id from public.subscription_products where code = 'midwifery-cbt'),
    'midwifery-250-daily',
    'Midwifery · 250 Daily',
    4990,
    'NGN',
    7500,
    null,
    1,
    jsonb_build_object('dailyLimit', 250),
    true,
    250,
    30,
    'daily-250',
    75),
  ('1f7fb93b-6442-4c89-90b8-672de7da8f13',
    (select id from public.subscription_products where code = 'community-health-cbt'),
    'community-100-daily',
    'Community Health · 100 Daily',
    2900,
    'NGN',
    3000,
    null,
    1,
    jsonb_build_object('dailyLimit', 100),
    true,
    100,
    30,
    'daily-100'),
  ('74ebc7dd-2a95-45bf-b2df-6ac6e23a11d9',
    (select id from public.subscription_products where code = 'community-health-cbt'),
    'community-200-daily',
    'Community Health · 200 Daily',
    3900,
    'NGN',
    6000,
    null,
    1,
    jsonb_build_object('dailyLimit', 200),
    true,
    200,
    30,
    'daily-200'),
  ('c65f26f0-094b-47bc-b1b7-6bd0e18a8fdf',
    (select id from public.subscription_products where code = 'community-health-cbt'),
    'community-250-daily',
    'Community Health · 250 Daily',
    4990,
    'NGN',
    7500,
    null,
    1,
    jsonb_build_object('dailyLimit', 250),
    true,
    250,
    30,
    'daily-250',
    75),
  ('8f55459c-1506-47b8-b13e-d7a01043ed27',
    (select id from public.subscription_products where code = 'quiz-builder'),
    'team-monthly',
    'Team Monthly',
    32000,
    'NGN',
    1000,
    50,
    10,
    jsonb_build_object('support', 'priority'),
    true,
    0,
    30,
    'team-monthly',
    null)
on conflict (product_id, code) do update set
  name = excluded.name,
  price = excluded.price,
  currency = excluded.currency,
  questions = excluded.questions,
  quizzes = excluded.quizzes,
  participants = excluded.participants,
  metadata = excluded.metadata,
  is_active = excluded.is_active,
  daily_question_limit = excluded.daily_question_limit,
  duration_days = excluded.duration_days,
  plan_tier = excluded.plan_tier,
  quiz_duration_minutes = excluded.quiz_duration_minutes,
  updated_at = timezone('utc', now());

insert into public.user_subscriptions (id, user_id, plan_id, status, started_at, price, currency)
values
  ('cf206c69-79ec-4f4c-9b2a-5a08690d45e1',
    '230348b8-0bf5-44a9-861e-4373289efdfc',
    (select id from public.subscription_plans where code = 'nursing-250-daily'),
    'active',
    timezone('utc', now()) - interval '12 days',
    4990,
    'NGN')
on conflict (id) do update set
  user_id = excluded.user_id,
  plan_id = excluded.plan_id,
  status = excluded.status,
  started_at = excluded.started_at,
  price = excluded.price,
  currency = excluded.currency,
  updated_at = timezone('utc', now());

-- Question bank -------------------------------------------------------------
insert into public.questions (id, topic_id, question_type, stem, explanation)
values
  ('89b5efb9-cec0-4d35-b8f3-048e1c18f7a5',
    (select id from public.topics where slug = 'infection-control'),
    'multiple_choice_single',
    'Which sequence best prevents cross-contamination when removing PPE after a dressing change?',
    'Remove gloves first to avoid contaminating other surfaces, then perform hand hygiene before touching clean PPE.'),
  ('89d505b4-5c9f-43a6-9f66-03bb36c692ba',
    (select id from public.topics where slug = 'vital-signs-assessment'),
    'multiple_choice_single',
    'A client''s blood pressure reads 88/56 mmHg on an automatic cuff. Which action should the nurse take first?',
    'Validate low readings manually to rule out equipment error before escalating.'),
  ('4a9f39a7-3159-4b3d-8edf-f16604b9fa45',
    (select id from public.topics where slug = 'post-operative-care'),
    'multiple_choice_single',
    'Four hours after abdominal surgery a client reports sudden shortness of breath and chest pain. What is the priority nursing action?',
    'Suspect pulmonary embolism and activate emergency response while preparing to administer oxygen.'),
  ('2f09c375-4437-452a-945e-4c55a6cde140',
    (select id from public.topics where slug = 'prenatal-screenings'),
    'multiple_choice_single',
    'At 12 weeks gestation, which screening should the midwife prioritise discussing with the client?',
    'First-trimester combined screening helps detect chromosomal abnormalities early.'),
  ('5a989fc2-1d20-4285-9e25-737c427005eb',
    (select id from public.topics where slug = 'labour-stages'),
    'multiple_choice_single',
    'Which finding indicates transition from latent to active labour?',
    'Cervical dilation progressing beyond 6 cm with stronger, regular contractions indicates active labour.'),
  ('19e06156-580d-4cdf-bcef-0a76fdd0fef0',
    (select id from public.topics where slug = 'outbreak-investigation'),
    'multiple_choice_single',
    'During an outbreak investigation, which step should follow verification of the diagnosis?',
    'Constructing an epidemic curve requires verifying and defining cases before analysing the outbreak pattern.'),
  ('5c94feae-6fb8-4d35-9d8c-3f281f68a7b7',
    (select id from public.topics where slug = 'health-education-methods'),
    'multiple_choice_single',
    'Which strategy best supports behavioural change in a community smoking cessation programme?',
    'Motivational interviewing tailors interventions to client readiness, improving engagement and outcomes.')
on conflict (id) do update set
  stem = excluded.stem,
  explanation = excluded.explanation,
  updated_at = timezone('utc', now());

insert into public.question_options (id, question_id, label, content, is_correct, order_index)
values
  ('b2fc1e59-d8fd-4870-a84d-6709cb890cc9', '89b5efb9-cec0-4d35-b8f3-048e1c18f7a5', 'A', 'Remove gloves, eye shield, gown, perform hand hygiene', true, 0),
  ('2b840d61-bdb3-4e54-89de-195ba0faea52', '89b5efb9-cec0-4d35-b8f3-048e1c18f7a5', 'B', 'Remove gown, gloves, perform hand hygiene, remove mask', false, 1),
  ('706d5192-4242-4de4-b08a-b467bafd3497', '89b5efb9-cec0-4d35-b8f3-048e1c18f7a5', 'C', 'Remove mask, gloves, gown, perform hand hygiene', false, 2),
  ('5213723c-02e7-4fa6-8b79-977f8272eba4', '89b5efb9-cec0-4d35-b8f3-048e1c18f7a5', 'D', 'Remove gloves, gown, mask, skip hand hygiene', false, 3),

  ('a9f6e9bf-5f4d-4f33-8f32-9dcd9e744be5', '89d505b4-5c9f-43a6-9f66-03bb36c692ba', 'A', 'Reassess manually using a different cuff immediately', true, 0),
  ('40a1a2de-f109-4379-a00d-3b3ba1968ac3', '89d505b4-5c9f-43a6-9f66-03bb36c692ba', 'B', 'Notify the provider before rechecking', false, 1),
  ('95e59b0a-b7ac-4e53-9bf0-18707c27c1fb', '89d505b4-5c9f-43a6-9f66-03bb36c692ba', 'C', 'Document the reading as hypotension and continue care', false, 2),
  ('ff0f9522-209f-4611-ab98-0ca61290acde', '89d505b4-5c9f-43a6-9f66-03bb36c692ba', 'D', 'Increase IV fluids before retaking the measurement', false, 3),

  ('b3045a28-8706-4555-8dc3-b4f161d18df4', '4a9f39a7-3159-4b3d-8edf-f16604b9fa45', 'A', 'Initiate oxygen therapy and summon rapid response', true, 0),
  ('6d9110ac-c0f9-4975-b5a8-b399f8ff8f8b', '4a9f39a7-3159-4b3d-8edf-f16604b9fa45', 'B', 'Encourage the client to ambulate and cough', false, 1),
  ('631f4fd9-1a50-48ae-bd95-17af0d875ce0', '4a9f39a7-3159-4b3d-8edf-f16604b9fa45', 'C', 'Administer prescribed opioid analgesia', false, 2),
  ('046c7b7c-7530-4092-8bf0-a509a2bbdbc5', '4a9f39a7-3159-4b3d-8edf-f16604b9fa45', 'D', 'Place the client in high Fowler position and reassess later', false, 3),

  ('ab4f36b2-5601-4d7c-9252-fcd6251a03bf', '2f09c375-4437-452a-945e-4c55a6cde140', 'A', 'First-trimester combined screening', true, 0),
  ('12c5dd7c-01cb-4b2d-8a4d-5a87c630180f', '2f09c375-4437-452a-945e-4c55a6cde140', 'B', 'Group B Streptococcus culture', false, 1),
  ('ad98aab9-5b41-4f08-98a6-2ab1bbeab4fd', '2f09c375-4437-452a-945e-4c55a6cde140', 'C', 'Anatomy ultrasound scan', false, 2),
  ('f4f878de-2f0c-4687-920f-80c3a0ad6984', '2f09c375-4437-452a-945e-4c55a6cde140', 'D', 'Oral glucose tolerance test', false, 3),

  ('6d9fc4a6-0f3c-45b2-a651-ac008e031b85', '5a989fc2-1d20-4285-9e25-737c427005eb', 'A', 'Cervical dilation 7 cm with regular contractions', true, 0),
  ('a4602a6b-d330-4f87-a0d0-198f5f6539ab', '5a989fc2-1d20-4285-9e25-737c427005eb', 'B', 'Irregular contractions every 12 minutes', false, 1),
  ('844035b1-3dd7-4aea-88e2-4968806c8891', '5a989fc2-1d20-4285-9e25-737c427005eb', 'C', 'Cervical dilation 3 cm with pink mucus show', false, 2),
  ('e7be5ca2-f0d6-4a13-b105-7779a15b3029', '5a989fc2-1d20-4285-9e25-737c427005eb', 'D', 'Cervical dilation 10 cm with urge to bear down', false, 3),

  ('480a4fb6-9958-4cbd-bdfc-6c76998821c3', '19e06156-580d-4cdf-bcef-0a76fdd0fef0', 'A', 'Define and identify cases', true, 0),
  ('86ee23ae-35cd-4f7a-80d2-4e2aeee26f42', '19e06156-580d-4cdf-bcef-0a76fdd0fef0', 'B', 'Implement targeted control measures', false, 1),
  ('2d8f5039-5451-40d6-b34a-89d4fd0728f9', '19e06156-580d-4cdf-bcef-0a76fdd0fef0', 'C', 'Evaluate effectiveness of interventions', false, 2),
  ('dd501f87-c0ba-42ff-a7eb-686efe6ad0f6', '19e06156-580d-4cdf-bcef-0a76fdd0fef0', 'D', 'Prepare the final investigation report', false, 3),

  ('9731088d-34e5-4baf-8f22-3583514ac4ec', '5c94feae-6fb8-4d35-9d8c-3f281f68a7b7', 'A', 'Motivational interviewing', true, 0),
  ('55745b1a-59e3-452a-9a7a-0fbbeb7acd07', '5c94feae-6fb8-4d35-9d8c-3f281f68a7b7', 'B', 'Mass distribution of printed flyers', false, 1),
  ('97723f6f-1efe-4a38-aa06-8cf0d22bb5cc', '5c94feae-6fb8-4d35-9d8c-3f281f68a7b7', 'C', 'One-time community health fair', false, 2),
  ('3be96161-cdb0-4a99-b210-9048e45dc76a', '5c94feae-6fb8-4d35-9d8c-3f281f68a7b7', 'D', 'Sharing weekly SMS tips without follow-up', false, 3)
on conflict (id) do update set
  content = excluded.content,
  is_correct = excluded.is_correct,
  order_index = excluded.order_index;

-- Refresh topic question counts --------------------------------------------
update public.topics t
set question_count = coalesce(q.count, 0)
from (
  select topic_id, count(*) as count
  from public.questions
  group by topic_id
) as q
where q.topic_id = t.id;

update public.topics
set question_count = 0
where id not in (select topic_id from public.questions);
